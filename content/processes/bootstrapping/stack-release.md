# Stack: Release

## Overview
This document provides guidelines about the configuration required to deploy Release stack on the kubernetes cluster.

## Details
Release Stack details can found on this [link](/content/tools/release/chartmuseum/developer-documentation.html).

## Configuration

This section provides high level overview of configuration: 

* Release stack [repository](https://github.com/stakater/StakaterKubeHelmRelease) resides on Github.

* Release stack can be deployed by Jenkins but in a new deployment when jenkins is not available, we need some online service like Bitbucket or Gitlab CI/CD pipeline. Currently, we are only supporting Gitlab.

* Github Personal Access Token will be used to pull stack repository.

## Deployment

* Create a repository on Gitlab and configure its [pipeline](/content/processes/bootstrapping/gitlab-pipeline-configuration.html).

* Gitlab CI/CD pipeline requires some environment variables, their description is given below:

| Environment Variables | Description | Location| 
|---|---|---|
| KUBE_CONFIG | Kubernetes configuration file. It must be provided as base64 encoded string.| Gitlab CI/CD Enviroment Variable |
| GITHUB_TOKEN  | Github Personal Access token. It can be generated by following this [guideline](https://github.com/stakater/til/blob/master/gitlab/gitlab-integration-with-github.md). | Gitlab CI/CD Environment Variable |
| NAMESPACE  | Deployment namespace. | Config file |
| PROVIDER  | Cloud provider's name. Currently, we support AWS and Azure. Its value can be provided as `aws` for AWS and `azure` for Azure. | Config file |
| INSTALL_PVC  | Flag to install PVC or not. Its value can be either `true` or `false`. | Config file |
| REPO_URL  | URL of the stack repository that need to be deployed. From each repository URL only the part after this section `https://` is required. Like from `https://github.com/stakater/til.git` URL we require only the `github.com/stakater/til.git` part | Config file |
| BRANCH  | Branch name that will be deployed. | Config file |
| TARGET  | Makefile target's name that will be executed. | Config file |

* Gitlab CI/CD environment variables can be configured from this dashboard `Project Setting -> CI/CD -> Variables`.

* Once environment variables are configured create a `.gitlab-ci.yml` file and paste the configuration given below in it:

```yaml
  image:
    name: stakater/gitlab:0.0.3

  before_script:

    - if [ $STACK == "global" ]; then \
    -     echo "Gloabl Stack"; \
    -     source ./global.sh; \
    
    - elif [ $STACK == "release" ]; then \ 
    -     echo "Release Stack"; \ 
    -     source ./release.sh; \
    
    - elif [ $STACK == "logging" ]; then \
    -     echo "Logging Stack"; \ 
    -     source ./logging.sh; \
    
    - elif [ $STACK == "monitoring" ]; then \
    -     echo "Monitoring Stack"; \ 
    -     source ./monitoring.sh; \
    
    - elif [ $STACK == "tracing" ]; then \
    -     echo "Tracing Stack"; \ 
    -     source ./tracing.sh; \
    
    - else \
    -     echo "Invalid stack name provided"
    -     exit 1 
    - fi

    - echo "configuration kubernetes access in pipeline"
    - mkdir ~/.kube/
    - echo $KUBE_CONFIG | base64 -d > config
    - mv config ~/.kube/

    - echo "Extracting repository name from the URL"
    - BASE_NAME=$(basename $REPO_URL)
    - REPO_NAME=${BASE_NAME%.*}

  stages:
    - deploy

  deploy:
    stage: deploy
    script:
      
      - echo "Cloning repository and redirecting the output to black hole because we don't want GITHUB_TOKEN to be visible on pipeline logs"
      - git clone https://$GITHUB_TOKEN@$REPO_URL > /dev/null

      - echo "Moving inside cloned repository directory"
      - cd $REPO_NAME

      - echo "Checkout to the deployment branch"
      - git checkout $BRANCH

      - echo "Deploying stack on kubernetes cluster"
      - if [ -z "$NAMESPACE" ]; then \
      -       make $TARGET PROVIDER_NAME=$PROVIDER INSTALL_PVC=$INSTALL_PVC; \
      - else \
      -       make $TARGET NAMESPACE=$NAMESPACE PROVIDER_NAME=$PROVIDER INSTALL_PVC=$INSTALL_PVC; \      
      - fi
```

* Once configuration is done, run the Gitlab pipeline for deployment.


