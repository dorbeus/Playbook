# Stack: Release

## Overview
This document provides guidelines about the configuration required to deploy Release stack on the kubernetes cluster.

## Details
Release Stack details can found on this [link](/content/tools/release/chartmuseum/developer-documentation.html).

## Configuration

This section provides high level overview of configuration: 

* Release stack [repository](https://github.com/stakater/StakaterKubeHelmRelease) resides on Github.

* Release stack can be deployed by Stakater's stack but in a new deployment when the stack is not available, we need some online service like Bitbucket or Gitlab CI/CD pipeline. Currently, we are only supporting Gitlab.

* Github Personal Access Token will be used to pull stack repository.

## Deployment

* Create a repository on Gitlab.

* Gitlab CI/CD pipeline requires some environment variables, their description is given below:

| Gitlab CI/CD Environment Variables | Description |
|---|---|
| KUBE_CONFIG_AWS  | Kubernetes configuration file. It must be provided as base64 encoded string. Guideline on how to encode and decode kube config can be found on this [link](https://github.com/stakater/til/blob/master/gitlab/gitlab-ci-pipeline-integration-with-kubernetes.md#using-gitlab-cicd-environment-variables) |
| NAMESPACE  | Deployment namespace. |
| PROVIDER  | Cloud provider's name. Currently, we support AWS and Azure. Its value can be provided as `aws` for AWS and `azure` for Azure. |
| REPO_URL  | URL of the stack repository that need to be deployed. From each repository URL only the part after this section `https://` is required. Like from `https://github.com/stakater/til.git` URL we require only the `github.com/stakater/til.git` part |
| GITHUB_TOKEN  | Github Personal Access token. It can be generated by following this [guideline](https://github.com/stakater/til/blob/master/gitlab/gitlab-integration-with-github.md). |
| BRANCH  | Branch name that will be deployed. |
| TARGET  | Makefile target's name that will be executed. |

* Gitlab CI/CD environment variables can be configured from this dashboard `Project Setting -> CI/CD -> Variables`.

* Once environment variables are configured create a `.gitlab-ci.yml` file and paste the configuration given below in it:

```yaml
image:
  name: stakater/gitlab:0.0.2

before_script:

  # configuration kubernetes access in pipeline
  - mkdir ~/.kube/
  - echo $KUBE_CONFIG_AWS | base64 -d > config
  - mv config ~/.kube/

  # cloning repo
  - echo "git clone https://$GITHUB_TOKEN@$REPO_URL" > script.sh
  - chmod +x script.sh

  # extracting repo name from the URL
  - BASE_NAME=$(basename $REPO_URL)
  - REPO_NAME=${BASE_NAME%.*}

stages:
  - deploy

deploy:
  stage: deploy
  script:

    # moving inside cloned repository directory
    - ./script.sh
    - cd $REPO_NAME

    # checkout to the branch that user wants to deploy.
    - git checkout $BRANCH

    # intalling stack on kubernetes cluster
    - make $TARGET NAMESPACE=$NAMESPACE PROVIDER_NAME=$PROVIDER
```

* Once configuration is done, run the Gitlab pipeline for deployment.


