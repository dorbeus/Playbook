# Stack: Global

## Overview
This document provides guidelines about the configurations required to deploy Global stack on the kubernetes cluster.

## Details
Global Stack details can found on this [link](/content/tools/global/external-dns/developer-documentation.md).

## Configuration

This section provides high level overview of configuration: 

* Global stack [repository](https://github.com/stakater/StakaterKubeHelmGlobal) resides on Github.

* Gitlab repository's CI/CD pipeline will be used to deploy Global stack due to following reason:
    
    * In a new kubernetes cluster some stack needs to be deployed before the other due to dependency.

* Github Personal Access Token will be used to pull repository.

## Deployment

* Create a repository on Gitlab.

* Gitlab CI/CD pipeline requires some environment variables, their description is given below:

| Variable | Description |
|---|---|
| KUBE_CONFIG_AWS  | Kubernetes configuration file |
| REPO_URL  | URL of the stack repository that need to be deployed. From each repository URL only the part after this section `https://` is required. Like from `https://github.com/stakater/til.git` URL we require only the `github.com/stakater/til.git` part |
| GITHUB_TOKEN  | Github Personal Access token. It can be generated by following this [guideline](https://github.com/stakater/til/blob/master/gitlab/gitlab-integration-with-github.md). |
| BRANCH_NAME  | If a user doesn;t wants to deploy the master branch he can specify the branch he want so deploy in this env var |

* Gitlab CI/CD environment variables can be configured from this dashboard `Project Setting -> CI/CD -> Variables`.

* Once environment variables are configured create a `.gitlab-ci.yml` file and insert the following configuration in it:

```yaml
image:
  name: stakater/gitlab:0.0.2

before_script:

  # configuration kubernetes access in pipeline
  - mkdir ~/.kube/
  - echo $KUBE_CONFIG_AWS | base64 -d > config
  - mv config ~/.kube/

  # cloning repo
  # currently irtiza's Personal access token is being used
  - echo "git clone https://$GITHUB_TOKEN@$REPO_URL" > script.sh
  - chmod +x script.sh

  # extracting repo name from the URL
  - BASE_NAME=$(basename $REPO_URL)
  - REPO_NAME=${BASE_NAME%.*}

stages:
  - deploy

deploy:
  stage: deploy
  script:

    # moving inside cloned repository directory
    - ./script.sh
    - cd $REPO_NAME

    # checkout to the branch that user wants to deploy.
    - git checkout $BRANCH_NAME

    # intalling stack on kubernetes cluster
    - make install NAMESPACE=monitoring PROVIDER_NAME=$PROVIDER
```

* Once configuration is done, run the Gitlab pipeline for deployment.


