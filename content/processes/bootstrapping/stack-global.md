# Stack: Global

## Overview
This document provides guidelines about the configuration required to deploy Global stack on the kubernetes cluster.

## Details
Global Stack details can found on this [link](/content/tools/global/external-dns/developer-documentation.html).

## Configuration

This section provides high level overview of configuration: 

* Global stack [repository](https://github.com/stakater/StakaterKubeHelmGlobal) resides on Github.

* Global stack can be deployed by Jenkins but in a new deployment when jenkins is not available, we need some online service like Bitbucket or Gitlab CI/CD pipeline. Currently, we are only supporting Gitlab.

* Github Personal Access Token will be used to pull stack repository.

## Deployment

* Create a repository on Gitlab and configure its [pipeline](/content/processes/bootstrapping/gitlab-pipeline-configuration.html). 

* Gitlab CI/CD pipeline requires some environment variables, their description is given below:

| Gitlab CI/CD Environment Variables | Description |
|---|---|
| KUBE_CONFIG | Kubernetes configuration file. It must be provided as base64 encoded string.|
| NAMESPACE  | Deployment namespace. |
| PROVIDER  | Cloud provider's name. Currently, we support AWS and Azure. Its value can be provided as `aws` for AWS and `azure` for Azure. |
| REPO_URL  | URL of the stack repository that need to be deployed. From each repository URL only the part after this section `https://` is required. Like from `https://github.com/stakater/til.git` URL we require only the `github.com/stakater/til.git` part |
| GITHUB_TOKEN  | Github Personal Access token. It can be generated by following this [guideline](https://github.com/stakater/til/blob/master/gitlab/gitlab-integration-with-github.md). |
| BRANCH  | Branch name that will be deployed. |
| TARGET  | Makefile target's name that will be executed. |
| INSTALL_PVC  | Flag to install PVC or not. Its value can be either `true` or `false`. |

* Gitlab CI/CD environment variables can be configured from this dashboard `Project Setting -> CI/CD -> Variables`.

* Once environment variables are configured create a `.gitlab-ci.yml` file and paste the configuration given below in it:

```yaml
  image:
    name: stakater/gitlab:0.0.2

  before_script:

      # configuration kubernetes access in pipeline
    - mkdir ~/.kube/
    - echo $KUBE_CONFIG_AWS | base64 -d > config
    - mv config ~/.kube/

      # cloning repo
    - echo "git clone https://$GITHUB_TOKEN@$REPO_URL" > script.sh
    - chmod +x script.sh

      # extracting repo name from the URL
    - BASE_NAME=$(basename $REPO_URL)
    - REPO_NAME=${BASE_NAME%.*}

  stages:
    - deploy

  deploy:
    stage: deploy
    script:

      # cloning repository
      - ./script.sh > /dev/null

      # moving inside cloned repository directory
      - cd $REPO_NAME

      # checkout to the branch that user wants to deploy.
      - git checkout $BRANCH

      # deploying stack on kubernetes cluster.
      - if [ -z "$NAMESPACE" ]; then       make $TARGET PROVIDER_NAME=$PROVIDER; else       make $TARGET NAMESPACE=$NAMESPACE PROVIDER_NAME=$PROVIDER; fi
```

* Once configuration is done, run the Gitlab pipeline for deployment.


